@page "/"
@inject TodoService TodoService
@implements IDisposable

<PageTitle>Blazor WASM TodoList</PageTitle>

<div class="todo-app">
    <header class="app-header">
        <h1>Blazor WebAssembly</h1>
        <p class="subtitle">TodoList Application</p>
    </header>

    <div class="todo-container">
        <TodoInput OnAdd="HandleAdd" />

        @if (todos.Any())
        {
            <div class="filter-tabs">
                <button class="@(currentFilter == "all" ? "active" : "")" @onclick="() => SetFilter(\"all\")">
                    All (@todos.Count)
                </button>
                <button class="@(currentFilter == "active" ? "active" : "")" @onclick="() => SetFilter(\"active\")">
                    Active (@TodoService.GetActiveCount())
                </button>
                <button class="@(currentFilter == "completed" ? "active" : "")" @onclick="() => SetFilter(\"completed\")">
                    Completed (@TodoService.GetCompletedCount())
                </button>
            </div>

            <div class="todo-list">
                @foreach (var todo in GetFilteredTodos())
                {
                    <TodoItem Todo="todo"
                              OnToggle="HandleToggle"
                              OnDelete="HandleDelete"
                              OnUpdate="HandleUpdate" />
                }
            </div>

            <div class="todo-footer">
                <span class="todo-count">
                    @TodoService.GetActiveCount() item@(TodoService.GetActiveCount() != 1 ? "s" : "") left
                </span>
                @if (TodoService.GetCompletedCount() > 0)
                {
                    <button class="clear-completed" @onclick="HandleClearCompleted">
                        Clear completed (@TodoService.GetCompletedCount())
                    </button>
                }
            </div>
        }
        else
        {
            <div class="empty-state">
                <p>No todos yet. Add one above to get started!</p>
            </div>
        }
    </div>

    <footer class="app-footer">
        <p>Double-click a todo to edit â€¢ Data persists in LocalStorage</p>
        <p class="tech-stack">
            Built with <strong>Blazor WebAssembly</strong> + <strong>.NET 8</strong>
        </p>
    </footer>
</div>

@code {
    private List<Todo> todos = new();
    private string currentFilter = "all";

    protected override async Task OnInitializedAsync()
    {
        await TodoService.InitializeAsync();
        todos = TodoService.GetTodos();
        TodoService.OnChange += StateHasChanged;
    }

    private List<Todo> GetFilteredTodos()
    {
        return currentFilter switch
        {
            "active" => todos.Where(t => !t.IsCompleted).ToList(),
            "completed" => todos.Where(t => t.IsCompleted).ToList(),
            _ => todos
        };
    }

    private void SetFilter(string filter)
    {
        currentFilter = filter;
    }

    private async Task HandleAdd(string text)
    {
        await TodoService.AddTodoAsync(text);
        todos = TodoService.GetTodos();
    }

    private async Task HandleToggle(int id)
    {
        await TodoService.ToggleTodoAsync(id);
        todos = TodoService.GetTodos();
    }

    private async Task HandleDelete(int id)
    {
        await TodoService.DeleteTodoAsync(id);
        todos = TodoService.GetTodos();
    }

    private async Task HandleUpdate((int Id, string Text) data)
    {
        await TodoService.UpdateTodoAsync(data.Id, data.Text);
        todos = TodoService.GetTodos();
    }

    private async Task HandleClearCompleted()
    {
        await TodoService.ClearCompletedAsync();
        todos = TodoService.GetTodos();
    }

    public void Dispose()
    {
        TodoService.OnChange -= StateHasChanged;
    }
}
